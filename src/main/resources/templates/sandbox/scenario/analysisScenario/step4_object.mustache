{{>layout/header}}
<style type="text/css">
.left_tbl tr:hover { 
	background-color: #ffffe0 !important;
	cursor : pointer;
}
.left_tbl tr.on {
	background-color: #ffffe0 !important;
}
</style>
        <div class="right_col" role="main">
          <div class="row">
            <div class="col-md-12">
              <div class="x_panel"> 
                <div class="x_title"> 
                  <h2>시나리오</h2>
                  <div class="clearfix"> </div>
                </div>
                <div class="x_content"> <br>
                  <div class="scenario_depth"> 
                    <ul>
                      <li id="ps1">시나리오 작성</li>
                      <li id="ps2">분석모델 설정</li>
                      <li id="ps3">전처리 모델 설정</li>
                      <li id="ps4">분석 대상 설정</li>
                    </ul>
                  </div>
                  <div>
                    <div class="tab_item">
                      <h3>▣ 분석 시나리오 세부 정보 입력 - 분석 데이터셋 등록 </h3>
                      <div class="row mx-0">
                        <h4 class="center_title">분석 데이터셋 이름</h4>
                        <div class="form-group row col-12 col-md-12 mx-0">
                          <label class="control-label">분석 데이터셋 이름 <span class="red">*</span></label>
                          <div class="form-control_box col-md-10">
                            <input class="form-control" type="text" name="anals_dataset_nm" id="anals_dataset_nm">
                          </div>
                        </div>
                      </div>
                      <div class="row">
                         <h4 class="mt-4 center_title">분석 데이터셋 파일 검색 및 등록</h4>
                         <div class="x_content">
                         	<div class="right_btns"> 
			                    <div class="row port_search">
			                      <div class="form-group row">
			                      	<div class="control-label">이미지 데이터셋 이름</div>
			                        <div class="form-control_box">
			                          <input class="form-control" type="text" name="query" id="query" onkeypress="enterkey(event);">
			                        </div>
			                      </div>
			                      <button class="btn btn-primary btn-sm" onclick="analysisTargetImagesGet();">조회</button>
			                    </div>
		                  	</div>
                         </div>
                         <div class="metatable_box col-5">
                          	<div class="form-group row">
	                          <div class="table_responsive" style="height: 300px; overflow: auto">
	                            <table class="table table-striped table-bordered bulk_action">
	                              <colgroup>
	                                <col width="55px">
	                                <col width="20%">
	                                <col width="">
	                                <col width="13%">
	                                <col width="13%">
	                                <col width="13%">
	                              </colgroup>
	                              <thead>
	                                <tr>
	                                  <th rowspan="2">등록여부</th>
	                                  <th rowspan="2">이미지 데이터셋 이름</th>
	                                  <th rowspan="2">설명</th>
	                                  <th colspan="3">파일 수(용량)</th>
	                                </tr>
	                                <tr>
	                                  <th>학습</th>
	                                  <th>검증</th>
	                                  <th>테스트</th>
	                                </tr>
	                              </thead>
	                              <tbody class="left_tbl" id="imageDataset">
	                              </tbody>
	                            </table>
	                          </div>
	                   		</div>
                   	  	</div>
                   	  	<div class="col-2 col-lg-1 d-flex justify-content-center p-0" style="flex-direction: column;">
							<button class="btn btn-secondary align-self-center" onclick="addImageDataset();">
								<i class="glyphicon glyphicon-chevron-right"></i>
							</button>
							<button class="btn btn-secondary align-self-center" onclick="removeImageDataset();">
								<i class="glyphicon glyphicon-chevron-left"></i>
							</button>
						</div>
                   	  	<div class="metatable_box col-5 col-lg-6">
                          <div class="form-group row">
	                          <div class="table_responsive" style="height: 300px; overflow: auto">
	                            <table class="table table-striped table-bordered bulk_action">
	                              <colgroup>
	                                <col width="55px">
	                                <col width="">
	                                <col width="13%">
	                                <col width="13%">
	                                <col width="13%">
	                              </colgroup>
	                              <thead>
	                                <tr>
	                                  <th rowspan="2">선택</th>
	                                  <th rowspan="2">이미지 데이터셋 이름</th>
	                                  <th colspan="3">파일 수(용량)</th>
	                                </tr>
	                                <tr>
	                                  <th>학습</th>
	                                  <th>검증</th>
	                                  <th>테스트</th>
	                                </tr>
	                              </thead>
	                              <tbody id="selected_imageDataset">
	                              </tbody>
	                            </table>
	                          </div>
	                    	</div>
	                    	<table class="table table-striped table-bordered bulk_action">
	                              <colgroup>
	                                <col width="55px">
	                                <col width="">
	                                <col width="13%">
	                                <col width="13%">
	                                <col width="13%">
	                              </colgroup>
	                              <thead>
	                                <tr>
	                                  <th>합계</th>
	                                  <th id="total_cnt"></th>
	                                  <th id="total_train_cnt"></th>
	                                  <th id="total_valid_cnt"></th>
	                                  <th id="total_test_cnt"></th>
	                                </tr>
	                              </thead>
	                            </table>
                   	  	</div>
                      </div>
                      <div class="row"> 
	                    <div class="metatable_box col-12">
	                      <h4 class="center_title">분석 데이터셋 설명</h4>
	                      <div class="form-group row">
	                        <label class="control-label">분석 데이터셋 설명</label>
	                        <div class="form-control_box duplicate_box">
	                          <input class="form-control" type="text" name="anals_dataset_desc" id="anals_dataset_desc" placeholder="분석 데이터셋 설명">
	                        </div>
	                      </div>
	                    </div>
	                  </div>
                      <div class="right_btns mt-4">
                        <button class="btn btn-secondary" onclick="jsNext('P');">이전</button>
                        <button class="btn btn-warning" onclick="analysisImageTargetSettingUpdate('T');">임시저장</button>
                        <button class="btn btn-success" onclick="analysisImageTargetSettingUpdate('N');">등록</button>
                        <button class="btn btn-primary" onclick="jsList();">목록</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- modal -->
        <div class="modal fade add_modal" id="add_modal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-md">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel"><span id="modelLabel">샘플 데이터 팝업</span></h4>
                <button class="close" type="button" data-dismiss="modal"></button><span aria-hidden="true">&times;</span>
              </div>
              <div class="modal-body">
                <div class="x_content"> 
                  <div class="table_responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr> 
                          <th colspan="2">▣ 테이블 정보</th>
                        </tr>
                      </thead>
                    </table>
                  </div>
                  <div class="border_rows">
                    <div class="row">
                      <div class="form-group row col-12 col-md-12">
                        <div class="control-label">테이블명(한글)</div>
                        <div class="form-control_box" id="anals_model_nm"></div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="form-group row col-12 col-md-12">
                        <div class="control-label">테이블명(영문)</div>
                        <div class="form-control_box" id="anals_model_desc"></div>
                      </div>
                    </div>
                  </div>
                  <div class="table_responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr> 
                          <th colspan="2">▣ 샘플 데이터</th>
                        </tr>
                      </thead>
                    </table>
                  </div>
                  <div class="table_responsive">
                    <table class="table table-striped">
                   	  <colgroup> 
                        <col width="55px">
                      </colgroup>
                      <thead>
                        <tr> 
                          <th></th>
                          <th>timestamp</th>
                          <th>pm10</th>
                          <th>co2</th>
                          <th>no2</th>
                        </tr>
                      </thead>
                      <tbody id="sample_data">
                      	<tr>
                      		<td>1</td>
                      		<td>t1</td>
                      		<td>x</td>
                      		<td>x</td>
                      		<td>x</td>
                      	</tr>
                      	<tr>
                      		<td>2</td>
                      		<td>t1</td>
                      		<td>x</td>
                      		<td>x</td>
                      		<td>x</td>
                      	</tr>
                      	<tr>
                      		<td>3</td>
                      		<td>t1</td>
                      		<td>x</td>
                      		<td>x</td>
                      		<td>x</td>
                      	</tr>
                      	<tr>
                      		<td>4</td>
                      		<td>t1</td>
                      		<td>x</td>
                      		<td>x</td>
                      		<td>x</td>
                      	</tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-primary" type="button" data-dismiss="modal">확인</button>
              </div>
            </div>
          </div>
        </div>
        <input type="hidden" name="regst_status_cd" id="regst_status_cd"/>
        <input type="hidden" name="model_setup_status_cd" id="model_setup_status_cd"/>
        <input type="hidden" name="pretreat_status_cd" id="pretreat_status_cd"/>
        <input type="hidden" name="target_setup_status_cd" id="target_setup_status_cd"/>
        <input type="hidden" name="last_status_cd" id="last_status_cd"/>
        
{{>layout/footer}}        

<script>
const commonUrl = '/sandbox/common';
const url = '/sandbox/scenario/analysisScenario';

const progressCd1 = 'B03001';	//등록 중
const progressCd2 = 'B03002';	//등록 완료

const setupCd1 = 'B01001'	//분석 대상만 설정
const setupCd2 = 'B01002'	//분석 모델, 전처리 모델, 분석 대상 설정

let imageObj = {};

$(document).ready(function(){
	let anals_detail_setting_cd = '{{anals_detail_setting_cd}}';
	let target_setup_status_cd = $("#target_setup_status_cd").val();
	
	if($("#regst_status_cd").val() != progressCd2){
		alert("시나리오 작성이 완료되지 않았습니다. 시나리오 작성 페이지로 이동합니다.");
		jsNext(1);
		return;
	}
	
	if(anals_detail_setting_cd == setupCd2){	//분석 모델, 전처리 모델, 분석 대상 설정
		if($("#model_setup_status_cd").val() != progressCd2){
			alert("분석모델 설정이 완료되지 않았습니다. 분석모델 설정 페이지로 이동합니다.");
			jsNext(2);
			return;
		}
		
		if($("#pretreat_status_cd").val() != progressCd2){
			alert("전처리 모델 설정이 완료되지 않았습니다. 분석모델 설정 페이지로 이동합니다.");
			jsNext(3);
			return;
		}
	}
	
	progressBar();
	
	if(target_setup_status_cd == progressCd1 || target_setup_status_cd == progressCd2){	//수정화면
		analysisTargetImagesDetail();
	}
});

//시나리오 등록 단계별 상태
const scenarioEnrollStepStatus = function (){
	let scenario_id = '{{scenario_id}}';
	if(!scenario_id){
		return;
	}
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/enroll-status',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };
	
	$.ajax({
        type: 'POST',
        url: url+'/scenarioEnrollStepStatus',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data),
        async: false,
    }).done(function (data) {
    	
    	 if (data != null) {
   	    	
   	    	if(data.contents != ""){
   	    		$("#regst_status_cd").val(data.contents.regst_status_cd);
   	    		$("#model_setup_status_cd").val(data.contents.model_setup_status_cd);
   	    		$("#pretreat_status_cd").val(data.contents.pretreat_status_cd);
   	    		$("#target_setup_status_cd").val(data.contents.target_setup_status_cd);
   	    		$("#last_status_cd").val(data.contents.last_status_cd);
   	    	}
    	 }
  		
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//시나리오 등록 > 분석 대상 설정 이미지 조회
const analysisTargetImagesGet = function () {
	
	let query = isEmpty($("#query").val());
	
	const data = {
   		url: '/services/sandbox/scenarios/analysis-target/image-dataset/get?search=image_dataset_nm:'+query+'',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };
	
    $.ajax({
        type: 'POST',
        url: url+'/analysisTargetImagesGet',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		$("#imageDataset").empty();
  	    	
  	    	if(data.contents != ""){
  	    		let insertTr = '';
		  	    $.each(data.contents, function (idx, el) {
		  	    	
		  	    	insertTr += '<tr>';
					insertTr += ' <td><input type="checkbox" name="image_dataset_id" id="d_id'+el.image_dataset_id+'" value="'+el.image_dataset_id+'" disabled></td>';
					insertTr += ' <td id="d_nm'+el.image_dataset_id+'" >'+el.image_dataset_nm+'</td>';
					insertTr += ' <td id="d_desc'+el.image_dataset_id+'" >'+el.image_dataset_desc+'</td>';
					insertTr += ' <td id="train'+el.image_dataset_id+'" >'+(el.train_cnt != null ? el.train_cnt : '')+'</td>';
					insertTr += ' <td id="valid'+el.image_dataset_id+'" >'+(el.valid_cnt != null ? el.valid_cnt : '')+'</td>';
					insertTr += ' <td id="test'+el.image_dataset_id+'" >'+(el.test_cnt != null ? el.test_cnt : '')+'</td>';
					insertTr += '</tr>';
		  	    });
		  	  $("#imageDataset").html(insertTr);
  	    	}
	  	  }
	  	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 대상 설정(이미지) 임시저장 & 저장 & 수정
const analysisImageTargetSettingUpdate = function(type){
	let scenario_id = '{{scenario_id}}';
	let anals_dataset_nm = $("#anals_dataset_nm").val();
	let anals_dataset_desc = $("#anals_dataset_desc").val();
	let image_dataset_ids = new Array();
	let image_dataset_len = $('input:checkbox[name="selected_image_dataset_id"]:checked').length;
	
	if(!anals_dataset_nm){
		alert('분석 데이터셋 이름을 입력하세요!');
		$("#anals_dataset_nm").focus();
        return;	
	}
	
	if(image_dataset_len == 0){
		alert('이미지 데이터셋을 추가하세요!');
        return;	
	}
	
	$('input:checkbox[name="selected_image_dataset_id"]:checked').each(function(){
		image_dataset_ids.push($(this).val());
	});
	
	let regstCd = '';
	let confirmMsg = '';
	if(type == 'T'){	//임시 저장
		regstCd = progressCd1;	//등록 중
		confirmMsg = '임시저장 하시겠습니까?';
	}else {		//다음
		regstCd = progressCd2;	//등록 완료
		confirmMsg = '저장 후 다음으로 이동하시겠습니까?';
	}
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/analysis-target/image-dataset/update',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
   		modifier_id: "modifier",
   		anals_dataset_nm: anals_dataset_nm,
   		anals_dataset_desc: anals_dataset_desc,
   		image_dataset_ids: image_dataset_ids,
   		target_setup_status_cd: regstCd
    };
	
	if(confirm(confirmMsg)){
	    $.ajax({
	        type: 'POST',
	        url: url+'/analysisImageTargetSettingUpdate',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	let message = JSON.stringify(data.return_msg);
// 	  		alert(message.replace(/\"/gi, ''));
			alert("저장 되었습니다.");
	  		if(type == 'T'){	//임시저장
	  			jsNext(4, scenario_id);
	  		}else{	//다음
	  			jsList();
	  		}    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	}
}

//분석 대상 설정 상세 조회(이미지)
const analysisTargetImagesDetail = function(){
	let scenario_id = '{{scenario_id}}';
	let imageDatasetIds = new Array();
	if(!scenario_id){
		return;
	}
	
	const data = {
		url: '/services/sandbox/scenarios/'+scenario_id+'/analysis-target/image-dataset/detail',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };
	
	$.ajax({
        type: 'POST',
        url: url+'/analysisTargetImagesDetail',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data),
    }).done(function (data) {
    	if (data != null) {
  	    	
  	    	if(data.contents != ""){
  	    		$('#anals_dataset_nm').val(data.contents.anals_dataset_nm);
  	    		$('#anals_dataset_desc').val(data.contents.anals_dataset_desc);
  	    		
  	    		for(let i=0; i<data.contents.image_dataset_ids.length; i++){
  	    			imageDatasetIds.push(data.contents.image_dataset_ids[i]);
  	    		}
  	    		
  	    		detailImageDataset(imageDatasetIds);
  	    	}
    	}
  		
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//이미지 데이터셋 모음 상세
const detailImageDataset = function(imageDatasetIds){
	for(let i=0; i<imageDatasetIds.length; i++){
		$('input:checkbox[name="image_dataset_id"][value="'+imageDatasetIds[i]+'"]').prop("checked",true);
		let insertTr = '<tr>';
			insertTr += '	<td><input type="checkbox" name="selected_image_dataset_id" value="'+imageDatasetIds[i]+'" checked></td>';
			insertTr += '	<td>'+$("#d_nm"+imageDatasetIds[i]).text()+'</td>';
			insertTr += '	<td>'+$("#train"+imageDatasetIds[i]).text()+'</td>';
			insertTr += '	<td>'+$("#valid"+imageDatasetIds[i]).text()+'</td>';
			insertTr += '	<td>'+$("#test"+imageDatasetIds[i]).text()+'</td>';
			insertTr += '</tr>';
		
		$("#selected_imageDataset").append(insertTr);
	}
	
	summaryImageDataset();
}

//이미지 데이터셋 모음에 추가
const addImageDataset = function(){
	let image_dataset_id = $('#imageDataset > tr.on').children().children().val();
	if(image_dataset_id){
 		let image_dataset_nm = $('#d_nm'+image_dataset_id).text();
 		let train_cnt = $('#train'+image_dataset_id).text();
 		let valid_cnt = $('#valid'+image_dataset_id).text();
 		let test_cnt = $('#test'+image_dataset_id).text();
 	    if(!imageObj.hasOwnProperty(image_dataset_id)){
 			imageObj[image_dataset_id] = image_dataset_nm;
 			let insertTr = '<tr>';
 				insertTr += '	<td><input type="checkbox" name="selected_image_dataset_id" value="'+image_dataset_id+'"></td>';
 				insertTr += '	<td>'+image_dataset_nm+'</td>';
 				insertTr += '	<td>'+train_cnt+'</td>';
 				insertTr += '	<td>'+valid_cnt+'</td>';
 				insertTr += '	<td>'+test_cnt+'</td>';
 				insertTr += '</tr>';
				
 			$("#selected_imageDataset").append(insertTr);
			
 	    }
	}
	summaryImageDataset();
}

//이미지 데이터셋 합계
const summaryImageDataset = function(){
	let total_cnt = 0;
	let total_train_cnt = 0;
	let total_valid_cnt = 0;
	let total_test_cnt = 0;
	
	$('#selected_imageDataset > tr').each(function (index) {
		let train_cnt = Number($(this).children().eq(2).text());
		let valid_cnt = Number($(this).children().eq(3).text());
		let test_cnt = Number($(this).children().eq(4).text());
		
		total_cnt += 1;
		total_train_cnt += train_cnt;
		total_valid_cnt += valid_cnt;
		total_test_cnt += test_cnt;
	});
	
	$("#total_cnt").text("총 "+total_cnt+"건");
	$("#total_train_cnt").text(total_train_cnt);
	$("#total_valid_cnt").text(total_valid_cnt);
	$("#total_test_cnt").text(total_test_cnt);
}

//이미지 데이터셋 모음에서 제거
const removeImageDataset = function(){
	$('input:checkbox[name="selected_image_dataset_id"]:checked').each(function (index) {
		delete imageObj[$(this).val()];
		$(this).parent().parent().remove();
	});
	
	summaryImageDataset();
}

//임시저장 & 이전/다음 단계 이동
const jsNext = function(step){
	let anals_use_prpos_cd = '{{anals_use_prpos_cd}}';
	let scenario_id = '{{scenario_id}}';
	let anals_detail_setting_cd = '{{anals_detail_setting_cd}}';
	
	if(step == 'P'){	//이전 버튼
		if(anals_detail_setting_cd == setupCd1)	{	//분석 대상만 설정
			step = 1;
		}else if(anals_detail_setting_cd == setupCd2){	//분석 모델, 전처리 모델, 분석 대상 설정
			step = 3;
		}
	}
	
	if(step == 1){
		location.href='/sandbox/scenario/analysisScenario/step1/'+scenario_id;
	}else if(step == 2){
		location.href='/sandbox/scenario/analysisScenario/step2/'+anals_detail_setting_cd+'/'+anals_use_prpos_cd+'/'+scenario_id;
	}else if(step == 3){
		location.href='/sandbox/scenario/analysisScenario/step3/'+anals_detail_setting_cd+'/'+anals_use_prpos_cd+'/'+scenario_id;
	}else{
		location.href='/sandbox/scenario/analysisScenario/step4/'+anals_detail_setting_cd+'/'+anals_use_prpos_cd+'/'+scenario_id;
	}
	
}

//진행상태 표시 바
const progressBar = function(){
	let regst_status_cd = $("#regst_status_cd").val();
	let model_setup_status_cd = $("#model_setup_status_cd").val();
	let pretreat_status_cd = $("#pretreat_status_cd").val();
	let target_setup_status_cd = $("#target_setup_status_cd").val();
	
	if(regst_status_cd == progressCd1){
		$("#ps1").addClass("temporary_storage");
	}else if(regst_status_cd == progressCd2){
		$("#ps1").addClass("save");
	}
	
	if(model_setup_status_cd == progressCd1){
		$("#ps2").addClass("temporary_storage");
	}else if(model_setup_status_cd == progressCd2){
		$("#ps2").addClass("save");
	}
	
	if(pretreat_status_cd == progressCd1){
		$("#ps3").addClass("temporary_storage");
	}else if(pretreat_status_cd == progressCd2){
		$("#ps3").addClass("save");
	}
	
	if(target_setup_status_cd == progressCd1){
		$("#ps4").addClass("temporary_storage");
	}else{
		$("#ps4").addClass("now_depth");
	}
}

//모달 상세정보
const detailModal = function(){
	$('#add_modal').modal('show');
}

//분석 시나리오 목록 페이지 이동
const jsList = function(){
	location.href = '/sandbox/scenario/analysisScenario/list';
}

//엔터키가 눌렸을 때
const enterkey = function(e) {
	if (e.keyCode == 13) {
		analysisTargetImagesGet();
    }
}

//클릭 색상 변경
$('#imageDataset').on('click', 'tr', function(){
	$('#imageDataset > tr').removeClass();
	$(this).addClass("on");
});

//시나리오 등록 단계별 상태
scenarioEnrollStepStatus();

//분석 대상 설정 이미지 조회
analysisTargetImagesGet();
</script>

