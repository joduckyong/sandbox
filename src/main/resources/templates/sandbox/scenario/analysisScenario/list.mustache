{{>layout/header}}

        <div class="right_col" role="main">
          <div class="row">
            <div class="col-md-12">
              <div class="x_panel"> 
                <div class="x_title"> 
                  <h2>HOME > 데이터 분석 > 분석 시나리오 관리</h2>
                  <div class="clearfix"> </div>
                </div>
                <div class="x_content"> <br>
                  <div class="right_btns"> 
                    <div class="row port_search">
                      <div class="form-group row">
                        <div class="control-label">분석 시나리오명</div>
                        <div class="form-control_box">
                          <input class="form-control" type="text" name="query" id="query" onkeypress="enterkey(event);">
                        </div>
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="analysisScenariosGet();">조회</button>
                    </div>
                  </div>
                   <div class="table_btns mt-4">
                    <button class="btn btn-primary" onclick="btnAdd();">등록</button>
                    <button class="btn btn-info" onclick="btnUpdate();">수정</button>
                    <button class="btn btn-danger" onclick="scenarioDelete();">삭제</button>
                  </div>
                  <div class="table_responsive">
                    <div class="talbel_total"><span class="red bold" id="total_count">7</span>건이 조회되었습니다.</div>
                    <table class="table table-striped">
                      <colgroup> 
                        <col width="5%">
                        <col width="13%">
                        <col width="12%">
                        <col width="12%">
                        <col width="12%">
                        <col width="12%">
                        <col width="5%">
                        <col width="12%">
                        <col width="12%">
                      </colgroup>
                      <thead>
                        <tr> 
                          <th>선택</th>
                          <th>시나리오명</th>
                          <th>분석 데이터셋</th>
                          <th>전처리 모델명</th>
                          <th>분석 모델</th>
                          <th>설명</th>
                          <th>등록자</th>
                          <th>등록일자</th>
                          <th>최종 수정 일자</th>
                        </tr>
                      </thead>
                      <tbody id="scenarioList">
                      </tbody>
                    </table>
                    <div class="nav justify-content-center"> 
                      <ul id="pagingul" class="pagination">
					  	</ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- modal -->
        <div class="modal fade add_modal" id="add_modal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">시나리오 상세 정보</h4>
                <button class="close" type="button" data-dismiss="modal"></button><span aria-hidden="true">&times;</span>
              </div>
              <div class="modal-body">
                <div class="x_content">
                  <ul class="nav nav-tabs bar_tabs">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#scenarioNm">시나리오</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#analysisModel">분석 모델</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#preprocessing">전처리 모델</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#analysisTarget">분석 대상</a></li>
                  </ul>
                  <div class="tab-content">
                    <div class="tab-pane fade show active" id="scenarioNm" role="tabpanel">
                        <h5>▣ 분석 시나리오 이름</h5>
                        <div class="border_rows">
	                      <div class="row">
	                        <div class="form-group row col-12 col-md-12">
	                          <div class="control-label">시나리오 한글 이름</div>
	                          <div class="form-control_box" id="scenarioNmKor"></div>
	                        </div>
	                      </div>
	                      <div class="row">
	                        <div class="form-group row col-12 col-md-12">
	                          <div class="control-label">시나리오 영문 이름</div>
	                          <div class="form-control_box" id="scenarioNmEng"></div>
	                        </div>
	                      </div>
	                    </div>
	                    <h5>▣ 분석 시나리오 세부 정보</h5>
	                    <div class="border_rows">
	                      <div class="row">
	                        <div class="form-group row col-12 col-md-12">
	                          <div class="control-label">분석 시나리오</div>
	                          <div class="form-control_box" id="scenarioInfo"></div>
	                        </div>
	                      </div>
	                      <div class="row">
	                        <div class="form-group row col-12 col-md-12">
	                          <div class="control-label">세부 분석 시나리오</div>
	                          <div class="form-control_box" id="scenarioInfoDetail"></div>
	                        </div>
	                      </div>
	                    </div>
	                    <h5>▣ 분석 시나리오 설명</h5>
	                    <div class="border_rows">
	                      <div class="row">
	                        <div class="form-group row col-12 col-md-12">
	                          <div class="control-label">분석 시나리오 설명</div>
	                          <div class="form-control_box" id="scenarioDesc"></div>
	                        </div>
	                      </div>
	                    </div>
                    </div>
                    <div class="tab-pane fade" id="analysisModel" role="tabpanel">
                      <h5>▣ 분석 모델</h5>
                      <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">분석 모델명</div>
	                        <div class="form-control_box" id="analysisModelNm"></div>
	                      </div>
	                    </div>
	                  </div>
	                  <h5>▣ 분석 모델 세부 정보</h5>
	                  <div class="table_responsive table-modal-height">
                        <table class="table table-striped table_center">
                          <colgroup> </colgroup>
                          <thead>
                            <tr> 
                              <th>데이터 분석 모델명</th>
                              <th>등록일자</th>
                            </tr>
                          </thead>
                          <tbody id="analysisModelInfo1">
                          </tbody>
                        </table>
                        <table class="table table-striped table_center">
                          <colgroup> </colgroup>
                          <thead>
                            <tr> 
                              <th>파라미터</th>
                              <th>정의</th>
                              <th>값</th>
                            </tr>
                          </thead>
                          <tbody id="analysisModelInfo2">
                          </tbody>
                        </table>
                      </div>
	                  <h5>▣ 분석 모델 설명</h5>
                      <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">분석 모델 설명</div>
	                        <div class="form-control_box" id="analysisModelDesc">분석 모델 설명</div>
	                      </div>
	                    </div>
	                  </div>
                    </div>
                    <div class="tab-pane fade" id="preprocessing" role="tabpanel">
                      <h5>▣ 분석 전처리 모델</h5>
                      <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">분석 전처리 모델명</div>
	                        <div class="form-control_box" id="pretreatModelNm"></div>
	                      </div>
	                    </div>
	                  </div>
	                  <h5>▣ 분석 전처리 모델 세부 정보</h5>
	                  <div class="table_responsive table-modal-height">
                        <table class="table table-striped table_center">
                          <colgroup> </colgroup>
                          <thead>
                            <tr> 
                              <th>전처리 분석 모델명</th>
                              <th>등록일자</th>
                            </tr>
                          </thead>
                          <tbody id="pretreatModelInfo1">
                          </tbody>
                        </table>
                        <table class="table table-striped table_center">
                          <colgroup> </colgroup>
                          <thead>
                            <tr> 
                              <th>전처리 단계</th>
                              <th>정의</th>
                              <th>조건/설명</th>
                            </tr>
                          </thead>
                          <tbody id="pretreatModelInfo2">
                          </tbody>
                        </table>
                      </div>
	                  <h5>▣ 분석 전처리 모델 설명</h5>
                      <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">분석 전처리 모델 설명</div>
	                        <div class="form-control_box" id="pretreatModelDesc">분석 전처리 모델 설명</div>
	                      </div>
	                    </div>
	                  </div>
                    </div>
                    <div class="tab-pane fade" id="analysisTarget" role="tabpanel">
                      <h5>▣ 분석 데이터셋 이름</h5>
                      <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">분석 데이터셋 이름</div>
	                        <div class="form-control_box" id="analysisDatasetNm">분석 데이터셋 이름</div>
	                      </div>
	                    </div>
	                  </div>
	                  <h5>▣ 분석 데이터셋 세부 정보</h5>
	                  <div class="table_responsive table-modal-height">
                        <table class="table table-striped table_center">
                          <colgroup> </colgroup>
                          <thead>
                            <tr> 
                              <th>#</th>
                              <th>이미지 데이터셋 이름</th>
                              <th>학습</th>
                              <th>검증</th>
                              <th>테스트</th>
                            </tr>
                          </thead>
                          <tbody id="analysisDatasetInfo">
                          </tbody>
                        </table>
                      </div>
	                  <h5>▣ 분석 데이터셋 설명</h5>
                      <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">분석 데이터셋 설명</div>
	                        <div class="form-control_box" id="analysisDatasetDesc">분석 데이터셋 설명</div>
	                      </div>
	                    </div>
	                  </div>
                    </div>
                    <div class="right_btns"> <a class="btn btn-primary" href="" data-dismiss="modal">확인</a></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
{{>layout/footer}}        

<script>
const commonUrl = '/sandbox/common';
const url = '/sandbox/scenario/analysisScenario';

const lastCd = 'B02008';

let init_page = 1;				//초기 페이지
let page = 1;					//페이지
let init_size_per_page = 10;	//초기 개수
let size_per_page = 10;	 		//가져올 개수
let pageCount = 10;		 		//페이징에 나타낼 페이지 수

//시나리오 등록 단계별 상태
const scenarioEnrollStepStatus = function (scenarioId){
	let scenario_id = scenarioId;
	if(!scenario_id){
		return;
	}
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/enroll-status',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };
	
	$.ajax({
        type: 'POST',
        url: url+'/scenarioEnrollStepStatus',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data),
        async: false,
    }).done(function (data) {
    	
    	 if (data != null) {
   	    	
   	    	if(data.contents != ""){
   	    		if(data.contents.last_status_cd == lastCd){	//전체 등록 완료
   	    			location.href = url+'/update/step1/'+scenarioId;
   	    		}else{
   	    			alert("아직 작성이 완료되지 않았습니다. 등록 화면으로 이동합니다.");
   	    			location.href = url+'/step1/'+scenarioId;
   	    		}
   	    	}
    	 }
  		
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 시나리오 목록 조회
const analysisScenariosGet = function (page, size_per_page) {
	
	if(!page){
		page = init_page;
	}
	if(!size_per_page){
		size_per_page = init_size_per_page;
	}	
	
	let query = isEmpty($("#query").val());
	
	const data = {
   		url: '/services/sandbox/scenarios/get?search=scenario_nm_kor:'+query+'&page_current='+page+'&sizePerPage='+size_per_page+'&sort=creatDatetime:desc',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };		
    $.ajax({
        type: 'POST',
        url: url+'/analysisScenariosGet',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		$("#scenarioList").empty();
  	    	$("#total_count").text(data.total_count);
  	    	
  	    	if(data.contents != ""){
  	    		let insertTr = '';
		  	    $.each(data.contents, function (idx, el) {
					insertTr += '<tr>';
					insertTr += ' <td><input type="radio" name="scenario_id" value="'+el.scenario_id+'"></td>';
					insertTr += ' <td><span class="blue bold" style="cursor:pointer" onclick="scenarioDetail('+el.scenario_id+');">'+el.scenario_nm_kor+'</span></td>';
					insertTr += ' <td>'+isEmpty(el.anals_dataset_nm)+'</td>';
					insertTr += ' <td>'+isEmpty(el.pretreat_model_nm)+'</td>';
					insertTr += ' <td>'+isEmpty(el.anals_model_nm)+'</td>';
					insertTr += ' <td>'+isEmpty(el.scenario_desc)+'</td>';
					insertTr += ' <td>'+el.creator_id+'</td>';
					insertTr += ' <td>'+el.creat_datetime+'</td>';
					insertTr += ' <td>'+el.modify_datetime+'</td>';
					insertTr += '</tr>';
		  	    });
		  	  $("#scenarioList").html(insertTr);
  	    	}
  	    	//페이징 보여줌
  	    	paging(data.total_count, size_per_page, pageCount, page);
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 시나리오 상세 정보 팝업 - 시나리오
const analysisScenariosPopupScenario = function (scenario_id) {
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/scenario-writing/popup',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };		
    $.ajax({
        type: 'POST',
        url: url+'/analysisScenariosPopupScenario',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
  	    	
  	    	if(data.contents != ""){
		  	  $("#scenarioNmKor").text(data.contents.scenario_nm_kor);
		  	  $("#scenarioNmEng").text(data.contents.scenario_nm_eng);
		  	  $("#scenarioInfo").text(data.contents.anals_use_prpos_cd_nm);
		  	  $("#scenarioInfoDetail").text(data.contents.anals_scenario_setup_cd_nm);
		  	  $("#scenarioDesc").text(data.contents.scenario_desc);
  	    	}
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 시나리오 상세 정보 팝업 - 분석 모델
const analysisScenariosPopupAnalysisModel = function (scenario_id) {
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/analysis-model/popup',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };		
    $.ajax({
        type: 'POST',
        url: url+'/analysisScenariosPopupAnalysisModel',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		$("#analysisModelInfo1").empty();
	  		$("#analysisModelInfo2").empty();
	  		
  	    	if(data.contents != ""){
		  	  	$("#analysisModelNm").text(data.contents.anals_model_nm);
		  	  	$("#analysisModelDesc").text(data.contents.anals_model_desc);
		  	  
			  	$.each(data.contents.file_infos, function (idx, el) {
	    			let insertTr = "<tr>";
	    				insertTr += '	<td>'+el.file_nm+'</td>';
	    				insertTr += '	<td></td>';
	    				insertTr += '</tr>';
	    				$("#analysisModelInfo1").append(insertTr);
	    		});
	    		
	    		$.each(data.contents.basic_infos, function (idx, el) {
	    			let insertTr = "<tr>";
	    				insertTr += '	<td>'+el.anals_model_stage+'</td>';
	    				insertTr += '	<td>'+el.anals_model_dfn+'</td>';
	    				insertTr += '	<td>'+el.anals_model_desc+'</td>';
	    				insertTr += '</tr>';
	    				$("#analysisModelInfo2").append(insertTr);
	    		});
  	    	}
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 시나리오 상세 정보 팝업 - 전처리 모델
const analysisScenariosPopupPretreatModel = function (scenario_id) {
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/pretreat-model/popup',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };		
    $.ajax({
        type: 'POST',
        url: url+'/analysisScenariosPopupPretreatModel',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		$("#pretreatModelInfo1").empty();
	  		$("#pretreatModelInfo2").empty();
	  		
  	    	if(data.contents != ""){
		  	  	$("#pretreatModelNm").text(data.contents.anals_model_nm);
		  	  	$("#pretreatModelDesc").text(data.contents.anals_model_desc);
		  	  
			  	$.each(data.contents.file_infos, function (idx, el) {
	    			let insertTr = "<tr>";
	    				insertTr += '	<td>'+el.file_nm+'</td>';
	    				insertTr += '	<td></td>';
	    				insertTr += '</tr>';
	    				$("#pretreatModelInfo1").append(insertTr);
	    		});
	    		
	    		$.each(data.contents.basic_infos, function (idx, el) {
	    			let insertTr = "<tr>";
	    				insertTr += '	<td>'+el.anals_model_stage+'</td>';
	    				insertTr += '	<td>'+el.anals_model_dfn+'</td>';
	    				insertTr += '	<td>'+el.anals_model_desc+'</td>';
	    				insertTr += '</tr>';
	    				$("#pretreatModelInfo2").append(insertTr);
	    		});
  	    	}
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 시나리오 상세 정보 팝업 - 분석 대상
const analysisScenariosPopupTarget = function (scenario_id) {
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/analysis-target/popup',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };		
    $.ajax({
        type: 'POST',
        url: url+'/analysisScenariosPopupTarget',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(data)
    }).done(function (data) {
    	
	  	  if (data != null) {
	  		$("#analysisDatasetInfo").empty();
	  		
  	    	if(data.contents != ""){
		  	  	$("#analysisDatasetNm").text(data.contents.anals_dataset_nm);
		  	  	$("#analysisDatasetDesc").text(data.contents.anals_dataset_desc);
		  	  
			  	$.each(data.contents.dataset_info, function (idx, el) {
	    			let insertTr = "<tr>";
	    				insertTr += '	<td>'+(idx+1)+'</td>';
	    				insertTr += '	<td>'+el.image_dataset_nm+'</td>';
	    				insertTr += '	<td>'+el.train_cnt+'</td>';
	    				insertTr += '	<td>'+el.valid_cnt+'</td>';
	    				insertTr += '	<td>'+el.test_cnt+'</td>';
	    				insertTr += '</tr>';
	    				$("#analysisDatasetInfo").append(insertTr);
	    		});
  	    	}
	  	  }
    	  
    }).fail(function (error) {
        alert(JSON.stringify(error));
    });	
}

//분석 시나리오 삭제
const scenarioDelete = function () {
	let scenario_id = $('input:radio[name="scenario_id"]:checked').val();
	if(!scenario_id){
		alert('선택 항목이 없습니다.');
		return;
	}
	
	const data = {
   		url: '/services/sandbox/scenarios/'+scenario_id+'/delete',
   		user_id: 'user00',	
   		menu_id: 'menu_id',
    };
	
	if(confirm("삭제 하시겠습니까?")){
		$.ajax({
	        type: 'POST',
	        url: url+'/scenarioDelete',
	        dataType: 'json',
	        contentType: 'application/json; charset=utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	  		let message = JSON.stringify(data.return_msg);
	  		alert(message.replace(/\"/gi, ''));
	  		analysisScenariosGet(page, size_per_page);
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	}
}

//분석 시나리오 상세 정보 팝업
const scenarioDetail = function(scenario_id){
	analysisScenariosPopupScenario(scenario_id);
	analysisScenariosPopupAnalysisModel(scenario_id);
	analysisScenariosPopupPretreatModel(scenario_id);
	analysisScenariosPopupTarget(scenario_id);
	addModal();
}

//모달 추가
const addModal = function(){
	$('#add_modal').modal('show');
}

//추가 버튼
const btnAdd = function(){
	location.href = '/sandbox/scenario/analysisScenario/step1';
}

//수정 버튼
const btnUpdate = function(){
	let scenario_id = $('input:radio[name="scenario_id"]:checked').val();
	if(!scenario_id){
		alert('선택 항목이 없습니다.');
		return;
	}
	
	scenarioEnrollStepStatus(scenario_id);
}

//페이징 함수 호출
const pagingFun = function(page, size_per_page){
	analysisScenariosGet(page, size_per_page);
}

//엔터키가 눌렸을 때
const enterkey = function(e) {
	if (e.keyCode == 13) {
		analysisScenariosGet();
    }
}

//조회
analysisScenariosGet();

</script>

